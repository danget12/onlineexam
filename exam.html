<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exam</title>
<style>
  :root{
    --primary:#1e88e5;          /* blue accents */
    --primary-700:#1565c0;
    --panel:#ffffff;
    --left:#f8f9fa;             /* left panel bg */
    --mid:#e7f3f5;              /* middle panel bg (question area) */
    --border:#d9e2ec;
    --warn:#f50000;
    --nav-size:36px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f8fb;color:#2b2b2b}
  header{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);background:#fff}
  header h1{font-size:18px;margin:0;flex:1}
  .timer{padding:6px 10px;border-radius:6px;background:#e7f3f5;border:1px solid var(--right);font-weight:600}
  .wrap{display:grid;grid-template-columns:240px 1fr 260px;gap:12px;padding:12px}
  .panel{border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff}

  /* Left panel */
  .left{background:var(--left);padding:14px}
  .qmeta{font-size:14px;color:#333;margin-bottom:10px}
  .flagBtn{width:100%;padding:10px;border:1px solid var(--warn);background:#fff;color:var(--warn);border-radius:6px;cursor:pointer}
  .flagBtn.active{background:#fff3e0}

  /* Middle panel */
  .mid{background:var(--panel);padding:14px;display:flex;flex-direction:column;gap:12px}
  .qcard{background:var(--mid);border:1px solid var(--border);border-radius:8px;padding:16px}
  .qtext{margin:0 0 12px 0;line-height:1.55}
  .opts label{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:6px;cursor:pointer}
  .opts input{margin-top:3px}
  .navRow{display:flex;justify-content:space-between;gap:8px}
  .btn{padding:10px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:600}
  .btn.prev{background:#eef2f7}
  .btn.next{background:var(--primary);color:#fff}
  .btn.next:hover{background:var(--primary-700)}

  /* Right panel */
  .right{background:#f8f9fa;padding:14px}
  .right h4{margin:0 0 10px 0}
  .grid{display:grid;grid-template-columns:repeat(6, var(--nav-size));gap:6px}
  .qnav{
    width:var(--nav-size);height:var(--nav-size);
    border:1px solid var(--border);border-radius:6px;cursor:pointer;
    display:grid;place-items:center;background:#fff;font-weight:600;
    position:relative; overflow:hidden;
  }
  /* half-fill when answered */
  .qnav.answered{
    background:linear-gradient(to top, var(--primary) 50%, #fff 50%);
    color:#fff; border-color:var(--primary);
  }
  /* small flag marker */
  .qnav.flagged::after{
    content:""; position:absolute; top:0; right:0; width:0; height:0;
    border-top:10px solid var(--warn); border-left:10px solid transparent;
  }
  .finish{margin-top:12px;width:100%;background:var(--primary);color:#fff}
  .finish:hover{background:var(--primary-700)}

  /* Responsive */
  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr;gap:10px}
    .grid{grid-template-columns:repeat(8, var(--nav-size))}
  }
</style>
</head>
<body>
<header>
  <h1 id="examTitle">Exam</h1>
  
</header>

<div class="wrap">
  <!-- LEFT -->
  <aside class="panel left">
    <div class="qmeta"><strong id="qnum">Question 1</strong><br>Marks: <span id="qmark">1</span></div>
    <button id="flagBtn" class="flagBtn" onclick="toggleFlag()">Flag question</button>
  </aside>

  <!-- MIDDLE -->
  <main class="panel mid">
    <div class="qcard">
      <div class="timer" id="timer" style ="text-align: right; color: red;">Time left: --:--</div>
      <p class="qtext" id="qtext"></p>
      <div class="opts" id="opts"></div>
    </div>
    <div class="navRow">
      <button class="btn prev" onclick="prevQ()">Previous</button>
      <button class="btn next" onclick="nextQ()">Next</button>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="panel right">
    <h4>Exam Navigation</h4>
    <div id="legend" style="font-size:12px;margin-bottom:8px;color:#555;">Half blue = answered</div>
    <div class="grid" id="qgrid"></div>
    <button class="btn finish" onclick="finishAttempt()">Finish attempt</button>
  </aside>
</div>

<script>
/* --------- URL params --------- */
const params   = new URLSearchParams(location.search);
const examId   = params.get('examid');
const username = params.get('user');

/* --------- storage keys --------- */
const KEY = `examState_${examId}`;

/* --------- runtime state --------- */
let QUESTIONS = [];              // loaded from questions.json
let state = {                    // saved/restored from localStorage
  answers: [],                   // option index per question (or null)
  flagged: [],
  current: 0,
  remaining: 0,                  // seconds remaining
  title: ''
};

/* --------- helpers --------- */
const mmss = s => {
  const m = Math.floor(s/60), x = s%60;
  return `${m}:${x<10?'0':''}${x}`;
};
function persist(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function restore(){ const s = JSON.parse(localStorage.getItem(KEY) || 'null'); return s || null; }

/* --------- load questions.json and init --------- */
(async function init(){
  try{
    const res = await fetch('questions.json');
    const all = await res.json();

    // support both array-of-exams or object keyed by examId
    let exam;
    if(Array.isArray(all)){ exam = all.find(e => e.examId===examId); }
    else if (all && all[examId]) { exam = { examId, title: examId, timeLimit: all[examId].timeLimit||30, questions: all[examId] }; }

    if(!exam){ document.body.innerHTML = '<div style="padding:20px">Exam not found.</div>'; return; }

    QUESTIONS = exam.questions.map(q => ({
      text: q.question || q.text,
      options: q.options,
      correct: (typeof q.correct !== 'undefined') ? q.correct : q.correctAnswer,
      mark: q.mark || 1
    }));

    // build or restore state
    const restored = restore();
    if(restored && restored.answers?.length === QUESTIONS.length){
      state = restored;
    }else{
      state.answers  = Array(QUESTIONS.length).fill(null);
      state.flagged  = Array(QUESTIONS.length).fill(false);
      state.current  = 0;
      state.remaining= (exam.timeLimit||30)*60;
    }
    state.title = exam.title || 'Exam';

    document.getElementById('examTitle').textContent = `${state.title} â€” ${username}`;
    document.getElementById('timer').textContent = `Time left: ${mmss(state.remaining)}`;

    // start timer
    setInterval(()=>{
      if(state.remaining<=0){ finishAttempt(); return; }
      state.remaining--; document.getElementById('timer').textContent = `Time left: ${mmss(state.remaining)}`;
      persist();
    }, 1000);

    render();
  }catch(err){
    document.body.innerHTML = '<div style="padding:20px;color:#b00020">Failed to load questions.json</div>';
    console.error(err);
  }
})();

/* --------- render UI --------- */
function render(){
  const i = state.current, q = QUESTIONS[i];

  // left meta
  document.getElementById('qnum').textContent = `Question ${i+1} of ${QUESTIONS.length}`;
  document.getElementById('qmark').textContent = q.mark ?? 1;
  const fb = document.getElementById('flagBtn');
  fb.classList.toggle('active', !!state.flagged[i]);
  fb.textContent = state.flagged[i] ? 'Remove flag' : 'Flag question';

  // middle question + options
  document.getElementById('qtext').textContent = q.text;
  const opts = document.getElementById('opts'); opts.innerHTML = '';
  q.options.forEach((opt, idx)=>{
    const id = `opt_${i}_${idx}`;
    const checked = state.answers[i] === idx ? 'checked' : '';
    opts.insertAdjacentHTML('beforeend', `
      <label for="${id}">
        <input id="${id}" type="radio" name="q${i}" ${checked} onclick="choose(${idx})" />
        ${opt}
      </label>
    `);
  });

  // right nav
  const grid = document.getElementById('qgrid'); grid.innerHTML = '';
  for(let k=0;k<QUESTIONS.length;k++){
    const b = document.createElement('button');
    b.className = 'qnav' + (state.answers[k]!==null ? ' answered' : '') + (state.flagged[k]?' flagged':'');
    b.textContent = k+1;
    b.title = state.answers[k]!==null ? 'Answered' : 'Not answered';
    b.onclick = ()=>{ state.current = k; persist(); render(); };
    grid.appendChild(b);
  }

  persist();
}

/* --------- actions --------- */
function choose(idx){
  state.answers[state.current] = idx;
  persist(); render(); // refresh right-panel half-fill
}
function toggleFlag(){
  state.flagged[state.current] = !state.flagged[state.current];
  persist(); render();
}
function prevQ(){ if(state.current>0){ state.current--; persist(); render(); } }
function nextQ(){ if(state.current<QUESTIONS.length-1){ state.current++; persist(); render(); } }


function finishAttempt(){
  // Save for safety
  sessionStorage.setItem(`answers_${examId}`, JSON.stringify(state.answers));
  // Also pass via URL (explicit)
  const ans = encodeURIComponent(JSON.stringify(state.answers));
  location.href = `summary.html?username=${encodeURIComponent(username)}&examId=${encodeURIComponent(examId)}&answers=${ans}`;
}


</script>
</body>
</html>
